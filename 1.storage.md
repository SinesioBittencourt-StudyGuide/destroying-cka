# Storage

## Undestanding Kubernetes Storage Options üíæ

To make the Pod data persistent we have some options:

- PersistentVolume Object: With the help of a claim(*PersistentVolumeClaim*) we define a PV(*PersistentVolume*) for use.
- ConfigMap: Is used to store files, directories and variables.
- Secrets: Encoded variables.

Pod using a shared volume between containers

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: sharedvolume
spec:
  containers:
  - name: centos1
    image: centos:7
    command:
    - sleep
    - "3600"
    volumeMounts:
    - mountPath: /centos1
      name: test
  - name: centos2
    image: centos:7
    command:
    - sleep
    - "3600"
    volumeMounts:
    - mountPath: /centos2
      name: test
  volumes:
  - name: test
    emptyDir: {}
```

&nbsp;

## Understand storage classes, persistent volumes üóÑ

&nbsp;

### Storage Classes

- Define a class type of storage.
- Storage Classes can make *specific* **PersistentVolumeClaims** bind to *specific* **PersistentVolumes** matching the same StorageClass only.
- In clusters, there's a **default StorageClass** offered to **PersistentVolumeClaims** that don't request any particular class to bind to.
- Default **StorageClass** are often provided in cloud environments.
- **PersistentVolumes** can be dinamically created by a **StorageClass**.
- Dinamically created **PersistentVolumes** needs a **reclaimPolicy** to defines what happens when to it when it's no longer used.

Common commands used to deal with Storage classes:

List all storage classes in the cluster

```shell
kubectl get storageclass 
```

Generate a storage class yaml tamplate

```shell
kubectl get storageclass -o yaml
```

StorageClass configuration example

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
reclaimPolicy: Retain
allowVolumeExpansion: true
mountOptions:
  - debug
volumeBindingMode: Immediate
```

References:

[Storage Classes](https://kubernetes.io/docs/concepts/storage/storage-classes/)

&nbsp;

### Persistent Volume

PersistentVolume is a Kubernetes Object that define a Storage for running Pods.

- **PersistentVolumes** are storages that Pods are bounded to.
- The **Pod** makes a request for storage with *specified* requirements.
- The PersistentVolume needs to match the Pod requirements for storage.
- The **PersistentVolumeClaim** works as a *bridge* betwen the **PersistentVolume** and the **Pod**, matching their specifications.
- Pod doesn't care where the Volume is, it just needs to store information.

PersistentVolume Configuration example

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-volume
  labels:
    type: local
spec:
  capacity:
    storage: 2Gi
  accessModes:
  -  ReadWriteOnce
  hostPath:
    path: "/mydata"
```

References:

[Persistent Volumes](https://kubernetes.io/docs/concepts/storage/persistent-volumes/)

&nbsp;

## Understand volume mode, access modes and reclaim policies for volumes üîê

&nbsp;

### Volume Modes

volumeMode is a optional API parameter, it provides a way to handle the volume access.

K8s supports 2 volumeModes of PersistentVolumes:

Filesystem:

- Default mode
- The volume is mounted into Pods into a directory.
- K8s creates a filesystem on the device before mounting it for the first time.(If it is in a empty block device)

Block:

- Use a volume as a raw block device, without any filesystem on it.
- Provides the Pod a fastest possible way to access the volume without the Filesystem layer between the Pod and the Volume.
- The application running in a Pod needs to handle the raw block device.

&nbsp;

### Access Modes

PersistentVolumes can be mounted on a host in any way supported by the resource(storage) providers.

The access modes are:

- **ReadWriteOnce** -- the volume can be mounted as read-write by a single node
- **ReadOnlyMany** -- the volume can be mounted read-only by many nodes
- **ReadWriteMany** -- the volume can be mounted as read-write by many nodes

In the CLI, the access modes are abbreviated to:

- RWO - ReadWriteOnce
- ROX - ReadOnlyMany
- RWX - ReadWriteMany

How it works?

The **PVC** searches for any PV that matches it's type.

&nbsp;

### Reclaim Policy

Current reclaim policies are:

- Retain -- manual reclamation
- Recycle -- basic scrub (rm -rf /thevolume/*)
- Delete -- associated storage asset such as AWS EBS, GCE PD, Azure Disk, or OpenStack Cinder volume is deleted

Change a PersistentVolume reclaim policy:

```shell
kubectl patch pv <your-pv-name> -p '{"spec":{"persistentVolumeReclaimPolicy":"Retain"}}'
```

References:

[Volume Modes](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#volume-mode)

[Change the Reclaim Policy of a PersistentVolume](https://kubernetes.io/docs/tasks/administer-cluster/change-pv-reclaim-policy/)

&nbsp;

## Understand persistent volume claims primitive üîê

A **PersistentVolumeClaim** (PVC) is a request for storage by a user. PVCs consume PV resources. Claims can request specific size and access modes (e.g., they can be mounted *ReadWriteOnce*, *ReadOnlyMany* or *ReadWriteMany*).

Each PVC contains a spec and status, which is the specification and status of the claim. The name of a **PersistentVolumeClaim** object must be a valid *DNS* subdomain name.

Pods access storage by using the claim as a volume.

### Persistent Volume Claims

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pv-claim
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
```

References:

[Reclaiming](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#reclaiming)

&nbsp;

## Know how to configure applications with persistent storage üîê

[Configure a Pod to Use a PersistentVolume for Storage](https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/)